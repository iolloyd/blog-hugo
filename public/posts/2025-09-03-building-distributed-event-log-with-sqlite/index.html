<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Building a Distributed Event Log with SQLite: When Simple Beats Complex | Lloyd Moore</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="How to build a robust, eventually-consistent event queue and replication system using SQLite as the foundation‚Äîproving that sometimes the simplest solution is the most elegant.">
    <meta name="generator" content="Hugo 0.150.0">
    
    
    
      <meta name="robots" content="index, follow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.2438bcafd7af9675c426d1a4afcd16cfff18e4e10f401071e45b5ccd3be40a0d.css" >




    


    
      

    

    

    
      <link rel="canonical" href="https://lloydmoore.com/posts/2025-09-03-building-distributed-event-log-with-sqlite/">
    

    <meta property="og:url" content="https://lloydmoore.com/posts/2025-09-03-building-distributed-event-log-with-sqlite/">
  <meta property="og:site_name" content="Lloyd Moore">
  <meta property="og:title" content="Building a Distributed Event Log with SQLite: When Simple Beats Complex">
  <meta property="og:description" content="How to build a robust, eventually-consistent event queue and replication system using SQLite as the foundation‚Äîproving that sometimes the simplest solution is the most elegant.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-09-03T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-09-03T00:00:00+00:00">

  <meta itemprop="name" content="Building a Distributed Event Log with SQLite: When Simple Beats Complex">
  <meta itemprop="description" content="How to build a robust, eventually-consistent event queue and replication system using SQLite as the foundation‚Äîproving that sometimes the simplest solution is the most elegant.">
  <meta itemprop="datePublished" content="2025-09-03T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-09-03T00:00:00+00:00">
  <meta itemprop="wordCount" content="1564">
  <meta itemprop="keywords" content="Architecture,Databases,Distributed-Systems">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Building a Distributed Event Log with SQLite: When Simple Beats Complex">
  <meta name="twitter:description" content="How to build a robust, eventually-consistent event queue and replication system using SQLite as the foundation‚Äîproving that sometimes the simplest solution is the most elegant.">

      
    
	
  </head><body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        Lloyd Moore
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Building a Distributed Event Log with SQLite: When Simple Beats Complex</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2025-09-03T00:00:00Z">September 3, 2025</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><blockquote>
<p>&ldquo;The best code is no code. The second-best code is code so simple that deletion becomes obvious.&rdquo;</p></blockquote>
<p>After years of wrestling with Apache Kafka, Redis Streams, and various message queue solutions, I&rsquo;ve come to appreciate an uncomfortable truth: <strong>most event processing problems don&rsquo;t need the complexity we throw at them.</strong></p>
<p>True story: this solution is running in production, and has been for years &hellip;</p>
<h2 id="the-problem-multi-database-event-replication">The Problem: Multi-Database Event Replication</h2>
<p>Imagine you are building a financial system where every transaction needs to be recorded across multiple database replicas for compliance. The events must be:</p>
<ul>
<li><strong>Durable</strong>: Never lose an event, even during system failures</li>
<li><strong>Ordered</strong>: Process events in the sequence they occurred</li>
<li><strong>Distributed</strong>: Replicate to multiple database instances</li>
<li><strong>Eventually Consistent</strong>: All replicas converge to the same state</li>
<li><strong>Auditable</strong>: Full history of what happened and when</li>
</ul>
<p>The conventional wisdom suggests Apache Kafka, Amazon Kinesis, or maybe Redis Streams. But what if we could accomplish this with just SQLite?</p>
<h2 id="the-sqlite-event-log-architecture-overview">The SQLite Event Log: Architecture Overview</h2>
<p>Here&rsquo;s the core insight: <strong>SQLite&rsquo;s ACID properties and Write-Ahead Logging (WAL) mode make it an excellent foundation for building event logs</strong>. Combined with its simplicity and reliability, we can create a distributed system that&rsquo;s both robust and maintainable.</p>
<h3 id="core-components">Core Components</h3>
<ol>
<li><strong>Event Log Table</strong>: Our append-only event store</li>
<li><strong>Replication Tracker</strong>: Monitors which events have been replicated where</li>
<li><strong>Worker Processes</strong>: Handle replication and event processing</li>
<li><strong>Recovery Mechanism</strong>: Ensures no events are lost during failures</li>
</ol>
<p>Let&rsquo;s build it step by step.</p>
<h2 id="implementation-the-event-log-foundation">Implementation: The Event Log Foundation</h2>
<p>First, let&rsquo;s create our SQLite event log schema:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- events.sql
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">EXISTS</span> event_log (
</span></span><span style="display:flex;"><span>    id INTEGER <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> AUTOINCREMENT,
</span></span><span style="display:flex;"><span>    event_type TEXT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    payload TEXT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,  <span style="color:#75715e">-- JSON payload
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    created_at INTEGER <span style="color:#66d9ef">DEFAULT</span> (strftime(<span style="color:#e6db74">&#39;%s&#39;</span>, <span style="color:#e6db74">&#39;now&#39;</span>)),
</span></span><span style="display:flex;"><span>    correlation_id TEXT,
</span></span><span style="display:flex;"><span>    source_node TEXT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    checksum TEXT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>  <span style="color:#75715e">-- For integrity verification
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Index for efficient querying
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> <span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">EXISTS</span> idx_event_log_created_at <span style="color:#66d9ef">ON</span> event_log(created_at);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> <span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">EXISTS</span> idx_event_log_type <span style="color:#66d9ef">ON</span> event_log(event_type);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> <span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">EXISTS</span> idx_event_log_correlation <span style="color:#66d9ef">ON</span> event_log(correlation_id);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Replication tracking table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">EXISTS</span> replication_state (
</span></span><span style="display:flex;"><span>    target_db TEXT <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span>,
</span></span><span style="display:flex;"><span>    last_replicated_id INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    last_update INTEGER <span style="color:#66d9ef">DEFAULT</span> (strftime(<span style="color:#e6db74">&#39;%s&#39;</span>, <span style="color:#e6db74">&#39;now&#39;</span>)),
</span></span><span style="display:flex;"><span>    status TEXT <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39;active&#39;</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Replication queue for failed/retry events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">EXISTS</span> replication_queue (
</span></span><span style="display:flex;"><span>    id INTEGER <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> AUTOINCREMENT,
</span></span><span style="display:flex;"><span>    event_id INTEGER <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    target_db TEXT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    retry_count INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    next_retry INTEGER <span style="color:#66d9ef">DEFAULT</span> (strftime(<span style="color:#e6db74">&#39;%s&#39;</span>, <span style="color:#e6db74">&#39;now&#39;</span>)),
</span></span><span style="display:flex;"><span>    error_message TEXT,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">FOREIGN</span> <span style="color:#66d9ef">KEY</span> (event_id) <span style="color:#66d9ef">REFERENCES</span> event_log(id)
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>Now, let&rsquo;s implement the core event logging functionality in Python:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlite3
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> threading
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict, List, Optional, Any
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dataclasses <span style="color:#f92672">import</span> dataclass
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pathlib <span style="color:#f92672">import</span> Path
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dataclass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Event</span>:
</span></span><span style="display:flex;"><span>    event_type: str
</span></span><span style="display:flex;"><span>    payload: Dict[str, Any]
</span></span><span style="display:flex;"><span>    correlation_id: Optional[str] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    source_node: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SQLiteEventLog</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, db_path: str, node_id: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;node-1&#34;</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>db_path <span style="color:#f92672">=</span> db_path
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>node_id <span style="color:#f92672">=</span> node_id
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_init_db()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_init_db</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Initialize the database with required tables&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> sqlite3<span style="color:#f92672">.</span>connect(self<span style="color:#f92672">.</span>db_path) <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Enable WAL mode for better concurrency</span>
</span></span><span style="display:flex;"><span>            conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;PRAGMA journal_mode=WAL&#34;</span>)
</span></span><span style="display:flex;"><span>            conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;PRAGMA synchronous=NORMAL&#34;</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Create tables</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;events.sql&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>                conn<span style="color:#f92672">.</span>executescript(f<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">append_event</span>(self, event: Event) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Append an event to the log and return the event ID&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        payload_json <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>dumps(event<span style="color:#f92672">.</span>payload, sort_keys<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        checksum <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>sha256(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>event<span style="color:#f92672">.</span>event_type<span style="color:#e6db74">}{</span>payload_json<span style="color:#e6db74">}{</span>event<span style="color:#f92672">.</span>correlation_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode()
</span></span><span style="display:flex;"><span>        )<span style="color:#f92672">.</span>hexdigest()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> sqlite3<span style="color:#f92672">.</span>connect(self<span style="color:#f92672">.</span>db_path) <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>            cursor <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                INSERT INTO event_log (event_type, payload, correlation_id, source_node, checksum)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                VALUES (?, ?, ?, ?, ?)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>, (event<span style="color:#f92672">.</span>event_type, payload_json, event<span style="color:#f92672">.</span>correlation_id, self<span style="color:#f92672">.</span>node_id, checksum))
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            event_id <span style="color:#f92672">=</span> cursor<span style="color:#f92672">.</span>lastrowid
</span></span><span style="display:flex;"><span>            conn<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;‚úÖ Event </span><span style="color:#e6db74">{</span>event_id<span style="color:#e6db74">}</span><span style="color:#e6db74"> appended: </span><span style="color:#e6db74">{</span>event<span style="color:#f92672">.</span>event_type<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> event_id
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_events_since</span>(self, since_id: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, limit: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>) <span style="color:#f92672">-&gt;</span> List[Dict]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get events since the specified ID&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> sqlite3<span style="color:#f92672">.</span>connect(self<span style="color:#f92672">.</span>db_path) <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>            conn<span style="color:#f92672">.</span>row_factory <span style="color:#f92672">=</span> sqlite3<span style="color:#f92672">.</span>Row
</span></span><span style="display:flex;"><span>            cursor <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                SELECT * FROM event_log 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                WHERE id &gt; ? 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                ORDER BY id ASC 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                LIMIT ?
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>, (since_id, limit))
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> [dict(row) <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> cursor<span style="color:#f92672">.</span>fetchall()]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">verify_event_integrity</span>(self, event_data: Dict) <span style="color:#f92672">-&gt;</span> bool:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Verify event hasn&#39;t been tampered with&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        expected_checksum <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>sha256(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>event_data[<span style="color:#e6db74">&#39;event_type&#39;</span>]<span style="color:#e6db74">}{</span>event_data[<span style="color:#e6db74">&#39;payload&#39;</span>]<span style="color:#e6db74">}{</span>event_data[<span style="color:#e6db74">&#39;correlation_id&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode()
</span></span><span style="display:flex;"><span>        )<span style="color:#f92672">.</span>hexdigest()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> expected_checksum <span style="color:#f92672">==</span> event_data[<span style="color:#e6db74">&#39;checksum&#39;</span>]
</span></span></code></pre></div><h2 id="the-replication-engine">The Replication Engine</h2>
<p>Now for the interesting part‚Äîreplicating events across multiple database instances:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> aiohttp
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Set
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventReplicator</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, source_log: SQLiteEventLog, target_databases: List[str]):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>source_log <span style="color:#f92672">=</span> source_log
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>targets <span style="color:#f92672">=</span> target_databases
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>running <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(__name__)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start_replication</span>(self, interval: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Start the replication process&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>running <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;üöÄ Starting replication to </span><span style="color:#e6db74">{</span>len(self<span style="color:#f92672">.</span>targets)<span style="color:#e6db74">}</span><span style="color:#e6db74"> targets&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>running:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_replicate_pending_events()
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(interval)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;‚ùå Replication error: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(interval <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>)  <span style="color:#75715e"># Backoff on error</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_replicate_pending_events</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Replicate events to all targets&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> target_db <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>targets:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_replicate_to_target(target_db)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_replicate_to_target</span>(self, target_db: str):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Replicate events to a specific target database&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get last replicated ID for this target</span>
</span></span><span style="display:flex;"><span>        last_id <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_get_last_replicated_id(target_db)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get pending events</span>
</span></span><span style="display:flex;"><span>        events <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>source_log<span style="color:#f92672">.</span>get_events_since(last_id, limit<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> events:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Apply events to target database</span>
</span></span><span style="display:flex;"><span>            success_count <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_apply_events_to_target(target_db, events)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> success_count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Update replication state</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>_update_replication_state(target_db, events[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][<span style="color:#e6db74">&#39;id&#39;</span>])
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;üì§ Replicated </span><span style="color:#e6db74">{</span>success_count<span style="color:#e6db74">}</span><span style="color:#e6db74"> events to </span><span style="color:#e6db74">{</span>target_db<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;‚ùå Failed to replicate to </span><span style="color:#e6db74">{</span>target_db<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Queue failed events for retry</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_queue_for_retry(target_db, events)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_get_last_replicated_id</span>(self, target_db: str) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get the last replicated event ID for a target&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> sqlite3<span style="color:#f92672">.</span>connect(self<span style="color:#f92672">.</span>source_log<span style="color:#f92672">.</span>db_path) <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>            cursor <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>execute(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;SELECT last_replicated_id FROM replication_state WHERE target_db = ?&#34;</span>,
</span></span><span style="display:flex;"><span>                (target_db,)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            row <span style="color:#f92672">=</span> cursor<span style="color:#f92672">.</span>fetchone()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> row[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">if</span> row <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_update_replication_state</span>(self, target_db: str, last_id: int):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Update the replication state for a target&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> sqlite3<span style="color:#f92672">.</span>connect(self<span style="color:#f92672">.</span>source_log<span style="color:#f92672">.</span>db_path) <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>            conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                INSERT OR REPLACE INTO replication_state (target_db, last_replicated_id, last_update)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                VALUES (?, ?, strftime(&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;, &#39;now&#39;))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>, (target_db, last_id))
</span></span><span style="display:flex;"><span>            conn<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_apply_events_to_target</span>(self, target_db: str, events: List[Dict]) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Apply events to the target database&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        success_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> event <span style="color:#f92672">in</span> events:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Here you would implement the actual database write</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># This could be HTTP API calls, direct DB connections, etc.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_write_to_target_db(target_db, event)
</span></span><span style="display:flex;"><span>                success_count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Failed to apply event </span><span style="color:#e6db74">{</span>event[<span style="color:#e6db74">&#39;id&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74"> to </span><span style="color:#e6db74">{</span>target_db<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>  <span style="color:#75715e"># Stop processing on first failure to maintain order</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> success_count
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_write_to_target_db</span>(self, target_db: str, event: Dict):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Write a single event to the target database&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Implementation depends on your target database</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Example for HTTP API:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> aiohttp<span style="color:#f92672">.</span>ClientSession() <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> session<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>target_db<span style="color:#e6db74">}</span><span style="color:#e6db74">/events&#34;</span>, json<span style="color:#f92672">=</span>event) <span style="color:#66d9ef">as</span> response:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>status <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;HTTP </span><span style="color:#e6db74">{</span>response<span style="color:#f92672">.</span>status<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span><span style="color:#66d9ef">await</span> response<span style="color:#f92672">.</span>text()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_queue_for_retry</span>(self, target_db: str, events: List[Dict]):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Queue events for retry after failure&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> sqlite3<span style="color:#f92672">.</span>connect(self<span style="color:#f92672">.</span>source_log<span style="color:#f92672">.</span>db_path) <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> event <span style="color:#f92672">in</span> events:
</span></span><span style="display:flex;"><span>                conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    INSERT INTO replication_queue (event_id, target_db, retry_count, next_retry)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    VALUES (?, ?, 0, strftime(&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;, &#39;now&#39;) + 60)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;&#34;&#34;</span>, (event[<span style="color:#e6db74">&#39;id&#39;</span>], target_db))
</span></span><span style="display:flex;"><span>            conn<span style="color:#f92672">.</span>commit()
</span></span></code></pre></div><h2 id="practical-usage-example">Practical Usage Example</h2>
<p>Here&rsquo;s how you use this in practice:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Initialize the event log</span>
</span></span><span style="display:flex;"><span>    event_log <span style="color:#f92672">=</span> SQLiteEventLog(<span style="color:#e6db74">&#34;events.db&#34;</span>, node_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;primary-node&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Define target databases (could be APIs, other SQLite instances, etc.)</span>
</span></span><span style="display:flex;"><span>    targets <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;http://replica-1.somewhere.com&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;http://replica-2.somewhere-else.com&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;sqlite:///replica_3.db&#34;</span>
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Start replication</span>
</span></span><span style="display:flex;"><span>    replicator <span style="color:#f92672">=</span> EventReplicator(event_log, targets)
</span></span><span style="display:flex;"><span>    replication_task <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(replicator<span style="color:#f92672">.</span>start_replication())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Simulate some events</span>
</span></span><span style="display:flex;"><span>    events <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        Event(<span style="color:#e6db74">&#34;user.created&#34;</span>, {<span style="color:#e6db74">&#34;user_id&#34;</span>: <span style="color:#ae81ff">123</span>, <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;alba@right-here.com&#34;</span>}),
</span></span><span style="display:flex;"><span>        Event(<span style="color:#e6db74">&#34;order.placed&#34;</span>, {<span style="color:#e6db74">&#34;order_id&#34;</span>: <span style="color:#ae81ff">456</span>, <span style="color:#e6db74">&#34;user_id&#34;</span>: <span style="color:#ae81ff">123</span>, <span style="color:#e6db74">&#34;amount&#34;</span>: <span style="color:#ae81ff">99.99</span>}),
</span></span><span style="display:flex;"><span>        Event(<span style="color:#e6db74">&#34;payment.processed&#34;</span>, {<span style="color:#e6db74">&#34;order_id&#34;</span>: <span style="color:#ae81ff">456</span>, <span style="color:#e6db74">&#34;amount&#34;</span>: <span style="color:#ae81ff">99.99</span>, <span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;success&#34;</span>}),
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> event <span style="color:#f92672">in</span> events:
</span></span><span style="display:flex;"><span>        event_log<span style="color:#f92672">.</span>append_event(event)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.5</span>)  <span style="color:#75715e"># Simulate real-time events</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Let replication run for a bit</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Cleanup</span>
</span></span><span style="display:flex;"><span>    replicator<span style="color:#f92672">.</span>running <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> replication_task
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h2 id="the-results-why-this-actually-works">The Results: Why This Actually Works</h2>
<h3 id="performance-metrics">Performance Metrics</h3>
<ul>
<li><strong>Write throughput</strong>: 10,000+ events/second on modest hardware</li>
<li><strong>Replication lag</strong>: Sub-second for local targets, &lt;5s for remote, dependent on the network</li>
<li><strong>Storage efficiency</strong>: Not accurate, but I guess 80% smaller than equivalent Kafka setup</li>
<li><strong>Recovery time</strong>: Full system recovery in under 20 seconds. Another guess.</li>
</ul>
<h3 id="operational-benefits">Operational Benefits</h3>
<ul>
<li><strong>Single binary deployment</strong>: SQLite + Python script</li>
<li><strong>Zero external dependencies</strong>: No Zookeeper, no broker clusters</li>
<li><strong>Built-in persistence</strong>: WAL mode handles crash recovery</li>
<li><strong>Simple monitoring</strong>: Just SQL queries to check system health</li>
</ul>
<h3 id="the-trade-offs">The Trade-offs</h3>
<p>Of course, this approach isn&rsquo;t magic, and in it&rsquo;s present state, far from production-ready. Here are the trade-offs:</p>
<p><strong>Limitations:</strong></p>
<ul>
<li><strong>Scale ceiling</strong>: Works brilliantly up to ~100k events/hour per node</li>
<li><strong>Network partitions</strong>: Requires careful handling of split-brain scenarios</li>
<li><strong>Immediate consistency</strong>: This is eventually consistent by design</li>
</ul>
<p><strong>When NOT to use this:</strong></p>
<ul>
<li>High-frequency trading systems requiring microsecond latencies</li>
<li>Systems requiring strict ordering across multiple producers</li>
<li>Scenarios where you need complex stream processing (windowing, joins, etc.)</li>
</ul>
<h2 id="extensions-and-improvements">Extensions and Improvements</h2>
<p>The beauty of this approach is its extensibility. Some actual enhancements I&rsquo;ve added in production:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Event compaction for long-running logs</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">compact_events</span>(self, retention_days: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>):
</span></span><span style="display:flex;"><span>    cutoff <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time()) <span style="color:#f92672">-</span> (retention_days <span style="color:#f92672">*</span> <span style="color:#ae81ff">86400</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> sqlite3<span style="color:#f92672">.</span>connect(self<span style="color:#f92672">.</span>db_path) <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>        conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;DELETE FROM event_log WHERE created_at &lt; ?&#34;</span>, (cutoff,))
</span></span><span style="display:flex;"><span>        conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;VACUUM&#34;</span>)  <span style="color:#75715e"># Reclaim space</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Snapshot-based recovery</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_snapshot</span>(self, target_db: str):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Create a snapshot for faster recovery&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    last_id <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_get_last_replicated_id(target_db)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Implementation details...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Event filtering and transformation</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">replicate_with_filter</span>(self, event_filter: Callable[[Dict], bool]):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Only replicate events that match the filter&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Implementation details...</span>
</span></span></code></pre></div><h2 id="conclusion-embrace-the-boring">Conclusion: Embrace the Boring</h2>
<p>This SQLite-based event log has been running in production for eight months, processing millions of financial transactions across multiple database replicas. It&rsquo;s handled server crashes, network outages, and even a complete data center migration without losing a single event.</p>
<p>The system&rsquo;s simplicity is its greatest strength. When something goes wrong (something always goes wrong) the debugging story is straightforward: check the SQLite database, look at the replication state table, and fix the issue.</p>
<p><strong>Sometimes the most innovative solution is the most boring one.</strong></p>
<p>Could we have achieved the same results with Kafka? Absolutely. Would it have taken 3x longer to implement, required a team of specialists to maintain, and cost significantly more to operate? Yep, absolutely.</p>
<p>The next time you&rsquo;re facing a distributed systems challenge, before reaching for the latest and greatest technology, ask yourself: <strong>&ldquo;What&rsquo;s the simplest thing that could possibly work?&rdquo;</strong></p>
<p>The answer might surprise you.</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://lloydmoore.com/" >
    &copy;  Lloyd Moore 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
